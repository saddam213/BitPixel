@using DotMatrix.Base.Extensions
@model DotMatrix.Common.Pixel.PixelViewlModel
@{
	ViewBag.Title = Model.Game.Name;

	var gameId = Model.Game.Id;
	var width = Model.Game.Width;
	var height = Model.Game.Height;
	var cacheBreak = DateTime.UtcNow.ToUnixMin();
}


@Html.AntiForgeryToken()

<style>
	.game-wrapper {
		position: relative;
		width: 100%;
		max-width: 100%;
		height: 100%;
		max-height: 100%;
		display: flex;
		overflow: hidden;
	}

	.game-container {
		width: 100%;
		overflow: hidden;
	}

	.menu-container {
		width: 100%;
		max-width: 400px;
		min-width: 320px;
		overflow: hidden;
	}

	#pixel-finder {
		position: absolute;
		display: none;
		width: 16px;
		height: 16px;
		text-align: center;
		z-index: 2000;
	}

	#canvas-container {
		position: relative;
		margin: auto;
	}

	.canvas-scroll-wrapper {
		height: 100%;
		overflow: hidden;
	}

	.canvas-scroll-container {
		height: 100%;
		overflow: auto;
	}

	#mainCanvas {
		border: solid 1px rgba(238, 232, 213, 0.325);
		background-color: rgba(238, 232, 213, 0.125);
	}

	#toolbar-window {
		display: flex;
		height: 100%;
		border: solid 1px rgba(238, 232, 213, 0.325);
		background-color: rgba(238, 232, 213, 0.1);
	}

	.game-link {
		margin-left: 30px;
		margin-right: 30px;
	}
</style>


<div class="game-wrapper">
	<div class="game-container">
		<div class="d-flex flex-column w-100 h-100">

			<div class="d-flex flex-column pt-2 pb-2">
				<div class="d-flex flex-column align-items-center">
					<h2 class="mb-0 text-primary">@Model.Game.Name</h2>
					<small class="text-muted" style="margin-top:-5px">
						@Model.Game.Description
					</small>
				</div>



				<div class="d-flex justify-content-center">
					<div class="d-flex flex-wrap justify-content-center" style="font-size: 20px ">
						<a href="/Scores/Game?gameId=@Model.Game.Id" class="game-link  text-primary"><i class="fa fa-list-ol mr-1"></i>Scoreboard</a>
						<a href="/Prizes/GameHistory?gameId=@Model.Game.Id" class="game-link  text-primary"><i class="fa fa-trophy"></i> Prizeboard</a>
						<a href="/Explore?gameId=@Model.Game.Id" class="game-link  text-primary"><i class="fa fa-search"></i> Explore</a>
						<a href="/Replay?gameId=@Model.Game.Id" class="game-link  text-primary"><i class="fa fa-film"></i> Replay</a>
					</div>
				</div>
			</div>

			<div class="canvas-scroll-wrapper">
				<div class="canvas-scroll-container">
					<div id="canvas-container" style="width:@(width)px;height:@(height)px">
						<div id="pixel-finder">
							<i class="fa fa-map-marker-alt" style="color:#ff0000;text-shadow: 1px 1px 1px black"></i>
						</div>
						<canvas id="mainCanvas" width="@width" height="@height" class="zoomed-out"></canvas>
					</div>
				</div>
			</div>


		</div>
	</div>

	<div class="menu-container">

		<div id="toolbar-window">
			<div class="d-flex flex-column flex-grow-1">


				<div class="pl-2 pr-2">
					<div class="d-flex justify-content-between">
						<div class=" w-100">
							<i style="font-size:11px">@(string.IsNullOrEmpty(User.Identity.Name) ? "Guest" : User.Identity.Name)</i>
							<div class="d-flex flex-column justify-content-center align-items-center">

								<h5 class="mb-0">Points: <b id="user-points" class=" text-warning">@Model.Points</b></h5>
								<div class="d-flex">

									<div class="d-flex" style="border:solid 0px red">
										<div style="width:50px">
											<span>X: <b class="text-primary" id="location-x">0</b></span>
										</div>
										<div style="width:50px;">
											<span>Y: <b class="text-primary" id="location-y">0</b></span>
										</div>
									</div>

								</div>
							</div>
						</div>

						<div class="w-100 pl-2 pb-2 pr-2" style="border-left:solid 1px rgba(238, 232, 213, 0.325)">
							<i style="font-size:11px">Selected Pixel</i>
							<div class="" style="font-size:14px">
								<div class="d-flex selected-pos">
									<div style="width:50px">
										<span>X: <b class="text-primary" id="selected-x">0</b></span>
									</div>
									<div style="width:50px">
										<span>Y: <b class="text-primary" id="selected-y">0</b></span>
									</div>


								</div>
								<div>
									<span>Points: <b class="text-primary" id="selected-points">0</b></span>
								</div>
								<div>
									<span>Player: <b class="text-primary" id="selected-user">-</b></span>
								</div>
							</div>
						</div>
					</div>
				</div>



				<div class="pl-2 pr-2" style="border-top: solid 1px rgba(238, 232, 213, 0.325)">

					<div class="d-flex flex-column">

						<div class="d-flex  justify-content-between">
							<div class="w-100">
								<div>
									<i style="font-size:11px">Zoom</i>
								</div>
								<div class="btn-toolbar" role="toolbar">
									<div class="btn-group" role="group">
										<button id="pixel-zoomout" type="button" class="btn btn-sm btn-secondary p-1" disabled="disabled" style="border-radius:0">
											<div style="width:30px;height:20px;">
												<i class="fal fa-search-minus"></i>
											</div>
										</button>
										<button id="pixel-zoomin" type="button" class="btn btn-sm btn-secondary p-1" style="border-radius:0">
											<div style="width:30px;height:20px;">
												<i class="fal fa-search-plus"></i>
											</div>
										</button>
									</div>
								</div>
							</div>

							<div class="w-100">
								<div>
									<i style="font-size:11px">Find</i>
								</div>

								<div>
									<div class="input-group input-group-sm align-items-center">
										<input id="jump-x" type="text" class="form-control form-control" placeholder="X" style="border-radius:0">
										<div class="input-group-append">
											<button id="jump-send" class="btn btn-secondary" type="button" style="border-radius:0;border:none;margin-left:1px">
												<i class="fa fa-map-marker-alt"></i>
											</button>
										</div>
										<input id="jump-y" type="text" class="form-control form-control-sm" placeholder="Y" style="border-radius:0">

									</div>
								</div>


							</div>

							<div class="w-100">

							</div>

						</div>

					</div>

					<div class="d-flex flex-column">

						<div class="d-flex justify-content-between">
							<div class="w-100">
								<div>
									<i style="font-size:11px">Pixel Color</i>
								</div>
								<div class="d-flex">
									<div id="color-picker" class="btn-toolbar" role="toolbar">
										<div class="btn-group btn-group-sm" role="group">
											<button id="color-dropdown" type="button" class="btn btn-secondary p-1" style="border-radius:0">
												<div class="d-flex justify-content-between align-content-center align-items-center">
													<div id="color-dropdown-selected" style="width:20px;height:20px;background-color:#000000"></div>
													<i class="fa fa-caret-down ml-1" style="font-size:larger"></i>
												</div>
											</button>
										</div>
									</div>
									<div class="btn-toolbar" role="toolbar">
										<div class="btn-group btn-group-sm ml-1" role="group">
											<button id="eyedrop-toggle" type="button" class="btn btn-secondary p-1 disabled" style="border-radius:0">
												<div style="width:20px;height:20px;">
													<i class="fal fa-eye-dropper"></i>
												</div>
											</button>
										</div>
									</div>
								</div>
							</div>

							<div class="w-100">
								<div>
									<span style="font-size:11px;">Max Points</span>
								</div>
								<input id="max-points" type="number" class="form-control form-control-sm btn-secondary" min="1" value="4" style="max-width:70px;border-radius:0" />
							</div>

							<div class="w-100" style="font-size:12px">
								<div class="custom-control custom-checkbox" style="margin-top:12px">
									<input type="checkbox" class="custom-control-input" id="transparent-toggle">
									<label class="custom-control-label" for="transparent-toggle" style="padding-top:2px">Show Transparent</label>
								</div>

								<div class="custom-control custom-checkbox">
									<input type="checkbox" class="custom-control-input" id="notifications-toggle">
									<label class="custom-control-label" for="notifications-toggle" style="padding-top:2px">Show Notifications</label>
								</div>
							</div>
						</div>

					</div>
				</div>

				<div class="flex-grow-1 mt-3" style="border-top:solid 1px rgba(238, 232, 213, 0.325);border-bottom:solid 1px rgba(238, 232, 213, 0.325);overflow-y:auto">
					<div id="log-window">
						<ul style="font-size:10px;list-style:none;padding-inline-start:0px" id="infolog"></ul>
					</div>
				</div>

				<div class="p-2">
					<div class="d-flex">
						<div id="chat-container" class="w-100">
							<div class="input-group input-group-sm align-items-center mb-2">
								<input id="chat-message" type="text" class="form-control" placeholder="Chat message..." style="border-radius:0">
								<div class="input-group-append">
									<button id="chat-send" class="btn btn-secondary" type="button" style="border-radius:0;border:none;">
										Send
									</button>
								</div>
							</div>
						</div>
					</div>
					<div class="d-flex justify-content-around" style="font-size:14px">
						<div class="custom-control custom-checkbox">
							<input type="checkbox" class="custom-control-input" id="log-toggle-pixel">
							<label class="custom-control-label" for="log-toggle-pixel">Log Pixels</label>
						</div>
						<div class="custom-control custom-checkbox">
							<input type="checkbox" class="custom-control-input" id="log-toggle-prize">
							<label class="custom-control-label" for="log-toggle-prize">Log Prizes</label>
						</div>
						<div class="custom-control custom-checkbox">
							<input type="checkbox" class="custom-control-input" id="log-toggle-error">
							<label class="custom-control-label" for="log-toggle-error">Log Errors</label>
						</div>
						<div class="custom-control custom-checkbox">
							<input type="checkbox" class="custom-control-input" id="log-toggle-chat">
							<label class="custom-control-label" for="log-toggle-chat">Log Chat</label>
						</div>
					</div>
				</div>

			</div>
		</div>

	</div>
</div>

<script id="logPixelTemplate" type="text/html">
	<li class="location-jump bg-dark" style="margin:1px;padding:1px" data-x="{{X}}" data-y="{{Y}}">
		<span class="text-light"><i class="fa fa-stop" style="width:14px;text-align:center;color:{{Color}}"></i>{{Player}} added pixel @@ X: {{X}}, Y: {{Y}}</span>
	</li>
</script>

<script id="logPrizeTemplate" type="text/html">
	<li class="location-jump bg-warning" style="margin:1px;padding:1px" data-x="{{X}}" data-y="{{Y}}">
		<span class="text-primary"><i class="fa fa-star" style="width:14px;text-align:center;"></i>{{Player}} won prize <b>{{Name}}</b> @@ X: {{X}}, Y: {{Y}}</span>
	</li>
</script>

<script id="logAwardTemplate" type="text/html">
	<li class="bg-warning" style="margin:1px;padding:1px">
		<span class="text-primary"><i class="fa fa-star" style="width:14px;text-align:center;"></i>{{Player}} won the <b>{{Name}}</b> award</span>
	</li>
</script>

<script id="logErrorTemplate" type="text/html">
	<li class="bg-danger" style="margin:1px;padding:1px">
		<span class="text-dark"><i class="fa fa-exclamation-square" style="width: 14px; text-align: center;"></i>Error: {{Message}}</span>
	</li>
</script>

<script id="logChatTemplate" type="text/html">
	<li class="bg-secondary" style="margin:1px;padding:1px">
		<div class="d-flex text-light">
			<div>
				<span style="white-space:nowrap">
					<i class="fa fa-comment-alt" style="width: 14px; text-align: center;"></i>
					<span>{{Sender}}</span>
				</span>
			</div>
			<div style="padding-left:6px;word-break:break-word">
				{{Message}}
			</div>
		</div>
	</li>
</script>

<script id="errorNotifyTemplate" type="text/html">
	<div class="toast bg-danger" role="alert" aria-live="assertive" aria-atomic="true" data-delay="2500">
		<div class="toast-header">
			<strong class="mr-auto">Error</strong>
			<small class="text-muted">just now</small>
			<button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
				<span aria-hidden="true">&times;</span>
			</button>
		</div>
		<div class="toast-body">
			<div class="text-center">
				{{Message}}
			</div>
		</div>
	</div>
</script>

<script id="prizeNotifyTemplate" type="text/html">
	<div class="toast bg-warning" role="alert" aria-live="assertive" aria-atomic="true" data-delay="10000">
		<div class="toast-header">
			<strong class="mr-auto text-warning"><i class="fa fa-trophy"></i> {{Name}}</strong>
			<small class="text-muted">just now</small>
			<button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
				<span aria-hidden="true">&times;</span>
			</button>
		</div>
		<div class="toast-body">
			<div class="text-center text-light">
				Congratulations you have won!
			</div>
			<div class="text-center text-light">
				<b style="font-size: larger">{{Description}}</b>
			</div>
		</div>
	</div>
</script>


<script id="awardNotifyTemplate" type="text/html">
	<div class="toast bg-warning" role="alert" aria-live="assertive" aria-atomic="true" data-delay="10000">
		<div class="toast-header">
			<strong class="mr-auto text-warning"><i class="fa fa-trophy"></i> {{Level}} Award</strong>
			<small class="text-muted">just now</small>
			<button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
				<span aria-hidden="true">&times;</span>
			</button>
		</div>
		<div class="toast-body">
			<div class="text-center text-light">
				Congratulations you have won!
			</div>
			<div class="text-center text-light">
				<b style="font-size: larger">{{Name}} - {{Points}} points</b>
			</div>
		</div>
	</div>
</script>


@section Scripts {


	<script>
		(async ($) => {

			const gameId = @gameId;
			const canvasWidth = @width;
			const canvasHeight = @height;
			const cacheBuster = '@cacheBreak';
			const userName = '@User.Identity.Name';

			const userSettings = store.get("gameSettings")	|| {
				color: '#000000',
				maxPoints: 2,
				showNotifications: true,
				showTransparent: true,

				showPixelLog: true,
				showPrizeLog: true,
				showAwardLog: true,
				showErrorLog: true,
				showChatLog: true
			};

			const saveSettings = () => {
				store.set("gameSettings", userSettings);
			}

			const loadSettings = () => {
				setSelectedColor(userSettings.color);
				$("#max-points").val(userSettings.maxPoints);
				toggleTransparentBackground();

				$("#log-toggle-pixel").prop("checked", userSettings.showPixelLog);
				$("#log-toggle-prize").prop("checked", userSettings.showPrizeLog);
				$("#log-toggle-award").prop("checked", userSettings.showAwardLog);
				$("#log-toggle-error").prop("checked", userSettings.showErrorLog);
				$("#log-toggle-chat").prop("checked", userSettings.showChatLog);

				$("#transparent-toggle").prop("checked", userSettings.showTransparent);
				$("#notifications-toggle").prop("checked", userSettings.showNotifications);
				$("#jump-x, #jump-y").val(null);
			}



			const pixelHub = $.connection.pixelHub;

			const mainCanvas = $("#mainCanvas");
			const canvasContainer = $("#canvas-container");
			const pixelFinder = $("#pixel-finder");
			const loggingWindow = $("#infolog");
			const logChatTemplate = $("#logChatTemplate").html();
			const logPixelTemplate = $("#logPixelTemplate").html();
			const logPrizeTemplate = $("#logPrizeTemplate").html();
			const logAwardTemplate = $("#logAwardTemplate").html();
			const logErrorTemplate = $("#logErrorTemplate").html();
			const prizeNotifyTemplate = $("#prizeNotifyTemplate").html();
			const awardNotifyTemplate = $("#awardNotifyTemplate").html();
			const errorNotifyTemplate = $("#errorNotifyTemplate").html();

			let scale = 1;
			const canvas = document.getElementById('mainCanvas');
			const context = canvas.getContext('2d');

			let isSmallLoaded = false;
			let isLargeLoaded = false;
			const backgroundSmall = new Image();
			const backgroundLarge = new Image();

			let eyedropperEnabled = false;




			const loadSmallBackground = () => {
				return new Promise(function (resolve, reject) {
					backgroundSmall.src = "../Content/Images/Games/" + gameId + "/background-small.png?v=" + cacheBuster;
					backgroundSmall.onload = function () {
						isSmallLoaded = true;
						return resolve();
					}
					backgroundSmall.onerror = function () {
						return resolve();
					}
				});
			}

			const loadLargeBackground = () => {
				return new Promise(function (resolve, reject) {
					backgroundLarge.src = "../Content/Images/Games/" + gameId + "/background-large.png?v=" + cacheBuster;
					backgroundLarge.onload = function () {
						isLargeLoaded = true;
						return resolve();
					}
					backgroundLarge.onerror = function () {
						return resolve();
					}
				});
			}


			const initializeCanvas = async () => {

				await loadSmallBackground();
				await loadLargeBackground();
				await initializeGame();

				canvas.addEventListener('mousedown', function (e) { e.preventDefault(); }, false);
				canvas.addEventListener('click', async function (evt) {
					evt.preventDefault();
					evt.stopImmediatePropagation();

					const mousePos = getMousePos(canvas, evt);
					const getPixelRequest = {
						gameId: gameId,
						x: parseInt(mousePos.x / scale),
						y: parseInt(mousePos.y / scale)
					}

					const pixelResponse = await getServerPixel(getPixelRequest);
					if (pixelResponse === undefined) {
						return;
					}

					setSelectedPixel(pixelResponse);
				});
				canvas.addEventListener('contextmenu', async function (evt) {
					evt.preventDefault();
					evt.stopImmediatePropagation();

					const mousePos = getMousePos(canvas, evt);
					let addPixelRequest = {
						gameId: gameId,
						x: parseInt(mousePos.x / scale),
						y: parseInt(mousePos.y / scale),
						color: userSettings.color,
						maxPoints: $("#max-points").val()
					}

					await addServerPixel(addPixelRequest);
				}, false);

				canvas.addEventListener('mousemove', function (evt) {
					const mousePos = getMousePos(canvas, evt);
					const locationData = {
						x: parseInt(mousePos.x / scale),
						y: parseInt(mousePos.y / scale)
					}
					setLocation(locationData)
				}, false);
			}

			const initializeGame = async () => {
				await resetCanvas(backgroundSmall)
				await getServerUpdates();

				pixelHub.client.OnNotifyPixel = function (notification) {
					addCanvasPixel(notification.X, notification.Y, notification.Color);
					updateSelectedPixel(notification);
					logPixel(notification);
				};

				pixelHub.client.OnNotifyPrize = function (notification) {
					logPrize(notification);
				};

				pixelHub.client.OnNotifyAward = function (notification) {
					logAward(notification);
				};

				pixelHub.client.OnUserNotifyPoints = function (notification) {
					updatePoints(notification);
					notifyPoints(notification);
				}

				pixelHub.client.OnUserNotifyPrize = function (notification) {
					notifyPrize(notification);
				}

				pixelHub.client.OnUserNotifyAward = function (notification) {
					notifyAward(notification);
				}

				pixelHub.client.OnChatMessage = function (result) {
					logChat(result);
				}

				await $.connection.hub.start();
				await pixelHub.server.joinGame(gameId);
			}

			const resetCanvas = async (background) => {
				canvas.height = canvasHeight * scale;
				canvas.width = canvasWidth * scale;
				canvasContainer.css({ width: canvas.width, height:canvas.height });

				context.setTransform(1, 0, 0, 1, 0, 0);
				context.clearRect(0, 0, canvas.width, canvas.height);
				context.drawImage(background, 0, 0);
				context.scale(scale, scale);
				await getServerUpdates();
			}

			const addCanvasPixel = async (x, y, color) => {
				context.beginPath();
				context.fillStyle = color,
				context.fillRect(x, y, 1, 1);
				context.closePath();
			}



			const setLocation = (location) => {
				$("#location-x").text(location.x);
				$("#location-y").text(location.y);
			}

			const setSelectedPixel = (pixel) => {
				$("#selected-x").text(pixel.X);
				$("#selected-y").text(pixel.Y);
				$("#selected-color").text(pixel.Color);
				if (eyedropperEnabled === true) {
					setSelectedColor(pixel.Color);
				}

				if (pixel.Type == 2) {
					$("#selected-points,#selected-user").html("<small><i>Fixed Pixel</i></small>");
					return;
				}

				$("#selected-points").html(pixel.Points);
				if (pixel.Type == 0) {
					$("#selected-user").html("<small><i>Empty Pixel</i></small>");
					return;
				}

				$("#selected-user").html(pixel.Player);
			}

			const updateSelectedPixel = (pixel) => {
				const selectedX = $("#selected-x").text();
				const selectedY = $("#selected-y").text();
				if (selectedX == pixel.X && selectedY == pixel.Y) {
					$("#selected-team").text(pixel.Team);
					$("#selected-owner").text(pixel.Player);
					$("#selected-points").text(pixel.Points);
				}
			}

			const zoomInCanvas = async () => {
				if (isLargeLoaded === true) {
					scale = 10;
					await resetCanvas(backgroundLarge);
					return true;
				}
				return false;
			}

			const zoomOutCanvas = async () => {
				if (isSmallLoaded === true) {
					scale = 1;
					await resetCanvas(backgroundSmall);
					return true;
				}
				return false;
			}

			const notifyPoints = (notification) => {
				if (userSettings.showNotifications === false) {
					return;
				}
				//notification.Points
			};

			const notifyPrize = (notification) => {
				if (userSettings.showNotifications === false) {
					return;
				}
				$("#toast-container").prepend($(Mustache.render(prizeNotifyTemplate, notification)).toast('show'));
			};

			const notifyAward = (notification) => {
				if (userSettings.showNotifications === false) {
					return;
				}

				notification.Level = Enums.GetName(Enums.AwardType, notification.Level);
				$("#toast-container").prepend($(Mustache.render(awardNotifyTemplate, notification)).toast('show'));
			};

			const notifyError = (error) => {
				if (userSettings.showNotifications === false) {
					return;
				}
				$("#toast-container").prepend($(Mustache.render(errorNotifyTemplate, {Message: error})).toast('show'));
			};

			const updatePoints = (result) => {
				$("#user-points").text(result.Points);
			};;


			const addServerPixel = async (data) => {
				if (userName.length == 0) {
					logError("You must be logged in to create pixels.");
					return;
				}
				const result = await postJson('@Url.Action("AddPixel", "Game")', data);
				if (result.Success == false) {
					logError(result.Message);
				}
			}

			const getServerPixel = async (data) => {
				const result = await postJson('@Url.Action("GetPixel", "Game")', data);
				if (result.Success == false) {
					logError(result.Message);
					return;
				}
				return result.Data;
			}

			const getServerUpdates = async () => {
				const deltas = await getJson('@Url.Action("GetPixels", "Game", new { gameId = Model.Game.Id})');
				if (deltas) {
					for (let i = 0; i < deltas.length; i++) {
						const pixel = deltas[i];
						addCanvasPixel(pixel.X, pixel.Y, pixel.Color);
					}
				}
			}


			const setSelectedColor = (color) => {
				userSettings.color = color;
				saveSettings();
				$("#color-dropdown").spectrum("set", color);
				$("#color-picker-selected, #color-dropdown-selected").css("background-color", color);
			}


			const logPixel = (pixel) => {
				if (userSettings.showPixelLog === false) {
					return;
				}

				loggingWindow.prepend(Mustache.render(logPixelTemplate, pixel));
			}

			const logPrize = (prize) => {
				if (userSettings.showPrizeLog === false) {
					return;
				}
				loggingWindow.prepend(Mustache.render(logPrizeTemplate, prize));
			}

			const logAward = (award) => {
				if (userSettings.showAwardLog === false) {
					return;
				}
				loggingWindow.prepend(Mustache.render(logAwardTemplate, award));
			}


			const logError = (error) => {
				if (userSettings.showErrorLog === false) {
					return;
				}
				loggingWindow.prepend(Mustache.render(logErrorTemplate, { Message: error }))
			}

			const logChat = (message) => {
				if (userSettings.showChatLog === false) {
					return;
				}
				loggingWindow.prepend(Mustache.render(logChatTemplate, message))
			}


			$("#log-toggle-pixel").on("click", function () {
				userSettings.showPixelLog = $(this).is(":checked");
				saveSettings();
			});

			$("#log-toggle-prize").on("click", function () {
				userSettings.showPrizeLog = $(this).is(":checked");
				saveSettings();
			});

			$("#log-toggle-award").on("click", function () {
				userSettings.showAwardLog = $(this).is(":checked");
				saveSettings();
			});

			$("#log-toggle-error").on("click", function () {
				userSettings.showErrorLog = $(this).is(":checked");
				saveSettings();
			});

			$("#log-toggle-chat").on("click", function () {
				userSettings.showChatLog = $(this).is(":checked");
				saveSettings();

				$("#chat-container").hide();
				if (userSettings.showChatLog === true) {
					$("#chat-container").show();
				}
			});


			$("#pixel-zoomin").on("click", async function () {
				if (await zoomInCanvas() === true) {
					$(this).attr("disabled", "disabled");
					$("#pixel-zoomout").removeAttr("disabled");
					mainCanvas.removeClass("zoomed-out").addClass("zoomed-in");
					pixelFinder.hide();
				}
			});

			$("#pixel-zoomout").on("click", async function () {
				if (await zoomOutCanvas() === true) {
					$(this).attr("disabled", "disabled");
					$("#pixel-zoomin").removeAttr("disabled");
					mainCanvas.removeClass("zoomed-in").addClass("zoomed-out");
					pixelFinder.hide();
				}
			});

			$("#transparent-toggle").on("click", async function () {
				userSettings.showTransparent = $(this).is(":checked");
				saveSettings();
				toggleTransparentBackground();
			})

			const toggleTransparentBackground = () => {
				mainCanvas.removeClass("checker-board");
				if (userSettings.showTransparent === true) {
					mainCanvas.addClass("checker-board");
				}
			}

			$("#notifications-toggle").on("click", async function () {
				userSettings.showNotifications = $(this).is(":checked");
				saveSettings();
			})


			$(".color-picker-item").on("click", function () {
				setSelectedColor($(this).data("color"));
			});

			$("#color-dropdown").spectrum({
				showPalette: true,
				showSelectionPalette: true,
				hideAfterPaletteSelect:true,
				preferredFormat: "hex",
				showInput: true,
				palette: [ "#FFFFFF","#000000","#FF0000","#00FF00","#0000FF","#FFFF00"],
				change: function(color) {
					setSelectedColor(color.toHexString());
				}
			});



			$("#eyedrop-toggle").on("click", function () {
				const _this = $(this);
				const isDisabled = _this.hasClass("disabled");
				if (isDisabled === true) {
					_this.removeClass("disabled").addClass("btn-warning");
					eyedropperEnabled = true;
					return;
				}

				_this.addClass("disabled").removeClass("btn-warning");
					eyedropperEnabled = false;
			});


			$("#prizes-modal").on("click", async function () {
				await openModalGet("/Prizes/ViewPrizesModal", { gameId: gameId });
			});


			pixelFinder.on("click", function () {
				pixelFinder.hide();
			});


			$("#log-window").on("click",".location-jump" ,function () {
				const _this = $(this);
				const x = _this.data("x");
				const y = _this.data("y");
				jumpToLocation(x, y);
			});


			const jumpToLocation = (x, y) => {

				const posx = x * scale;
				const posy = y * scale;
				const scrollContainer = $(".canvas-scroll-container");

				const containerWidth = scrollContainer.width();
				const containerHeight = scrollContainer.height();


				const deltaX = containerWidth / 8;
				const deltaY = containerHeight / 8;
				if (posx > (containerWidth - deltaX) || posx < (containerWidth - deltaX)) {
						scrollContainer.scrollLeft(posx - (containerWidth / 2));
				}


				if (posy > (containerHeight - deltaY) || posy < (containerHeight - deltaY)) {
				 scrollContainer.scrollTop(posy - (containerHeight / 2));
				}
				if (scale > 1) {
					pixelFinder.css({ left: posx - 2, top: posy - 20, "font-size": "22px" }).show();
					return;
				}
				pixelFinder.css({ left: posx - 7, top: posy - 17, "font-size": "14px" }).show();
			}

			$("#chat-send").on("click", async function () {
				const _this = $(this);
				const messageBox = $("#chat-message");
				const message = messageBox.val();
				if (message.length == 0) {
					return;
				}
				_this.attr("disabled", "disabled");
				messageBox.attr("disabled", "disabled");

				const dataMessage = message.substring(0, Math.min(240, message.length));
				await pixelHub.server.sendChatMessage(dataMessage);
				messageBox.val(null);
				messageBox.removeAttr("disabled");
				_this.removeAttr("disabled");
			})

			$("#chat-message").on("keyup", function (e) {
				if (e.keyCode == 13) {
					$("#chat-send").trigger("click");
				}
			});


			$("#jump-send").on("click", function () {
				const posX = Number($("#jump-x").val()) || 0;
				const posY = Number($("#jump-y").val() || 0);
				if (posX < 0 || posX > (canvasWidth - 1)) {
					$("#jump-x").addClass("text-danger");
					pixelFinder.hide();
					return;
				}
				if (posY < 0 || posY > (canvasHeight - 1)) {
					$("#jump-y").addClass("text-danger");
					pixelFinder.hide();
					return;
				}

				$("#jump-x, #jump-y").removeClass("text-danger")
				jumpToLocation(posX, posY);
			});

			$("#max-points").on("keyup change paste", function () {
				const value = Number($(this).val()) || 1;
				userSettings.maxPoints = Math.max(1, value);
				saveSettings();
			});

			$(".selected-pos").on("click", function () {
				$("#jump-x").val($("#selected-x").text());
				$("#jump-y").val($("#selected-y").text());
			})

			loadSettings();
			initializeCanvas();

		})(jQuery);

	</script>
}
